@using System.Security.Claims
@using Services
@using s20601.Data.Models.DTOs
@using s20601.Data.Models

@inject IRatingService RatingSvc
@inject NavigationManager NavigationManager

@if (_loading)
{
    <MudProgressLinear Color="Color.Default" Indeterminate="true"/>
}
else
{
    <MudStack Row="true" AlignItems="AlignItems.Center">
        <AuthorizeView>
            <NotAuthorized>
                <MudRating
                           SelectedValue="@((int)Math.Round(AvgRating))"
                           Size="@Size"
                           SelectedValueChanged="NavigateToLoginPage"/>
            </NotAuthorized>
            <Authorized>
                <AuthorizeView Policy="PointsAtLeast1" Context="authContext">
                    <Authorized Context="innerContext">
                        <MudRating
                                   SelectedValue="@(_currentUserMovieRating?.Rating ?? 0)"
                                   Size="@Size"
                                   SelectedValueChanged="OnRatingChanged"/>
                    </Authorized>
                    <NotAuthorized Context="innerContext">
                        <MudTooltip Text="You need at least 1 reputation point to rate movies">
                            <MudRating
                                       SelectedValue="@((int)Math.Round(AvgRating))"
                                       Size="@Size"
                                       ReadOnly="true"/>
                        </MudTooltip>
                    </NotAuthorized>
                </AuthorizeView>
            </Authorized>
        </AuthorizeView>

        <MudText Typo="Typo.body1">@Math.Round(AvgRating, 1)/5</MudText>
        <MudText Typo="Typo.body1">(@RateCount)</MudText>
    </MudStack>
}


@code {
    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    [Parameter] public Size Size { get; set; } = Size.Small;

    [Parameter] public required int MovieId { get; set; }

    private MovieRate? _currentUserMovieRating;

    private double AvgRating { get; set; }

    private int RateCount { get; set; }

    private string _userId = null!;

    MovieRatingSummary _ratingSummary = null!;

    private bool _loading;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        _ratingSummary = await RatingSvc.GetMovieRatingSummaryByIdAsync(MovieId);

        AvgRating = _ratingSummary.AvgRating;
        RateCount = _ratingSummary.RateCount;

        var authState = await AuthenticationStateTask;
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _userId = user.FindFirstValue(ClaimTypes.NameIdentifier) ?? "";
            _currentUserMovieRating = await RatingSvc.GetUserMovieRating(_userId, MovieId);
        }
        
        _loading = false;
    }

    private async Task OnRatingChanged(int newRating)
    {
        await RatingSvc.RateMovieAsync(MovieId, _userId, newRating);

        var updatedRating = await RatingSvc.GetMovieRatingSummaryByIdAsync(MovieId);
        if (updatedRating is null)
        {
            return;
        }

        AvgRating = updatedRating.AvgRating;
        RateCount = updatedRating.RateCount;

        if (_currentUserMovieRating is null)
        {
            _currentUserMovieRating = new MovieRate
            {
                Movie_Id = MovieId,
                IdUser = _userId,
                Rating = newRating
            };
        }
        else
        {
            _currentUserMovieRating.Rating = newRating;
        }
        
        StateHasChanged();
    }

    private void NavigateToLoginPage() => NavigationManager.NavigateTo("account/login", true);
}