@page "/"

@using s20601.Components.Movies.Components
@using s20601.Data.Models
@using s20601.Data.Models.DTOs
@using s20601.Services
@using s20601.Components.Common.Components

@inject IMovieService MovieSvc
@inject IMovieCollectionService MovieCollectionSvc

@if (_loading)
{
    <MudProgressLinear Color="Color.Default" Indeterminate="true"/>
}
else
{
    <MudText Typo="Typo.h4" Align="Align.Start" Class="mb-4">Movie of the day</MudText>

    <MudGrid>
        <MudItem xs="4">
            <MudPaper Elevation="0">
                <MovieCoverComponent MovieId="@_movieOfTheDay.Id"/>
            </MudPaper>
        </MudItem>
        <MudItem xs="8">
            <MudStack>
                <MudPaper Elevation="0">
                    @if (_movieOfTheDay is null)
                    {
                        <MudText Typo="Typo.subtitle1">No movie of the day yet!</MudText>
                    }
                    else
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Start">
                            <MudLink Href="@($"movie/{_movieOfTheDay.Id}")" Typo="Typo.h5">
                                @_movieOfTheDay.Title
                                <MudText Typo="Typo.subtitle1">(@_movieOfTheDay.StartYear)</MudText>
                            </MudLink>
                            <MudSpacer/>
                            <MovieEditRequestButton Movie="@_movieOfTheDay" ButtonText="Edit"
                                                    DialogTitle="Create movie update request"/>
                            <MovieShareButton Movie="@_movieOfTheDay"/>
                        </MudStack>
                    }
                </MudPaper>


                <MudPaper Elevation="0">
                    <MudText Typo="Typo.h6">Genres</MudText>
                    @if (_movieGenres.Count == 0)
                    {
                        <MudText Typo="Typo.subtitle1" Color="Color.Dark">No genres defined yet</MudText>
                    }
                    else
                    {
                        foreach (var genre in _movieGenres)
                        {
                            <MudChipSet T="Color" Class="d-inline-flex">
                                <MudChip>@genre.Name</MudChip>
                            </MudChipSet>
                        }
                    }
                </MudPaper>

                <MudPaper Elevation="0">
                    <MudText Typo="Typo.h6">Community rating</MudText>
                    <MovieRatingExtended MovieId="@_movieOfTheDay.Id" Size="Size.Medium"/>
                </MudPaper>


                <MudPaper Elevation="0">
                    <MudText Typo="Typo.h6">Community sentiment</MudText>
                    <CommunitySentiment MovieId="@_movieOfTheDay.Id" />
                </MudPaper>

                <MudPaper Elevation="0">
                    <MudText Typo="Typo.h6">Directors</MudText>
                    <MudGrid>
                        @if (_crew.All(member => member.Job != "Director"))
                        {
                            <MudItem>
                                <MudText Typo="Typo.subtitle1" Color="Color.Dark">
                                    We have no information about the directors
                                    for this movie.
                                </MudText>
                            </MudItem>
                        }
                        else
                        {
                            foreach (var member in _crew.Where(member => member.Job == "Director"))
                            {
                                <MudItem>
                                    <MudLink
                                        Href="@($"/persona/{@member.Id}")">@member.FirstName @member.LastName</MudLink>
                                </MudItem>
                            }
                        }
                    </MudGrid>
                </MudPaper>

                <MudPaper Elevation="0">
                    <MudText Typo="Typo.h6">Writers</MudText>
                    <MudGrid>
                        @if (_crew.All(member => member.Job != "Writer"))
                        {
                            <MudItem>
                                <MudText Typo="Typo.subtitle1" Color="Color.Dark">
                                    We have no information about the writers
                                    for this movie.
                                </MudText>
                            </MudItem>
                        }
                        else
                        {
                            foreach (var member in _crew.Where(member => member.Job == "Writer"))
                            {
                                <MudItem>
                                    <MudLink
                                        Href="@($"/persona/{@member.Id}")">@member.FirstName @member.LastName</MudLink>
                                </MudItem>
                            }
                        }
                    </MudGrid>
                </MudPaper>

                <MudPaper Elevation="0">
                    <MudText Typo="Typo.h6">Cast</MudText>
                    <MudGrid>
                        @if (_crew.All(member => member.Job != "Actor"))
                        {
                            <MudItem>
                                <MudText Typo="Typo.subtitle1" Color="Color.Dark">
                                    We have no information about the
                                    actors for this movie.
                                </MudText>
                            </MudItem>
                        }
                        else
                        {
                            foreach (var member in _crew.Where(member => member.Job == "Actor"))
                            {
                                <MudItem>
                                    <MudLink
                                        Href="@($"/persona/{@member.Id}")">@member.FirstName @member.LastName</MudLink>
                                    <MudText Typo="Typo.subtitle2"
                                             Color="Color.Dark">@member.CharacterName</MudText>
                                </MudItem>
                            }
                        }
                    </MudGrid>
                </MudPaper>
            </MudStack>
        </MudItem>
    </MudGrid>

    @if (_pastPicks.Count != 0)
    {
        <MudText Class="mt-6" Typo="Typo.h4">Past picks</MudText>
        @if (_pastPicks is null)
        {
            <MudText Typo="Typo.subtitle1" Color="Color.Dark">
                No past picks yet!
            </MudText>
        }
        else
        {
            <MudCarouselWithPagination Items=@_pastPicks itemsPerCarousel="5"></MudCarouselWithPagination>
        }
    }


    if (_trendingMovieCollections.Count != 0)
    {
        <MudText Typo="Typo.h4" Class="mt-6">Trending community collections</MudText>
        <MudCarouselWithPagination Items=@_trendingMovieCollections
                                   itemsPerCarousel="5"></MudCarouselWithPagination>
    }
}

@code {
    Movie? _movieOfTheDay;
    List<Genre> _movieGenres = null!;
    List<GetMovieCrewMemberWithDetails> _crew = null!;

    List<Movie> _pastPicks = null!;
    List<MovieCollection> _trendingMovieCollections = null!;

    private bool _loading;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;

        _movieOfTheDay = await MovieSvc.GetMovieOfTheDayAsync();
        if (_movieOfTheDay is not null)
        {
            var movieOfTheDayId = _movieOfTheDay.Id;
            _movieGenres = await MovieSvc.GetMovieGenresByIdAsync(movieOfTheDayId);
            _crew = await MovieSvc.GetMovieCrewByMovieIdAsync(movieOfTheDayId);
        }

        _pastPicks = await MovieSvc.GetPastMoviesOfTheDay(10);

        _trendingMovieCollections = await MovieCollectionSvc.GetTrendingMovieCollections(10);

        _loading = false;
    }

}
