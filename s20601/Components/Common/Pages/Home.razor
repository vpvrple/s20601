@page "/"

@using s20601.Data.Models
@using s20601.Data.Models.DTOs
@using s20601.Services
@using s20601.Components.Common.Components
@using s20601.Components.MovieCollections.Dialogs

@inject IMovieService MovieSvc
@inject IRatingService RatingSvc

@if (_loading)
{
    <MudProgressLinear Color="Color.Default" Indeterminate="true"/>
}
else
{
    <MudText Class="mt-6" Typo="Typo.h4">Movie of the day</MudText>
    <MudGrid>
        <MudItem lg="6" md="6" sm="12" xs="12" Style="position: relative;">
            <MudImage Src="favicon.png"
                      ObjectFit="ObjectFit.None"
                      Alt="Movie poster"
                      Elevation="1"
                      Style="width: 100%; height: auto;"/>
            <AuthorizeView>
                <MudPaper Elevation="0" Style="position: absolute; top: 25px; right: 0px;">
                    <BookmarkMovie MovieId="_movieOfTheDay.Id" />
                </MudPaper>
                
            </AuthorizeView>
        </MudItem>
        <MudItem lg="6" md="6" xs="12">
            <MudGrid Class="align-center">
                <MudItem xs="12">
                    @if (_movieOfTheDay is null)
                    {
                        <MudText Typo="Typo.subtitle1">No movie of the day yet!</MudText>
                    }
                    else
                    {
                        <MudLink Href="@($"movie/{_movieOfTheDay.Id}")" Typo="Typo.h5">
                            @_movieOfTheDay.Title
                            <MudText Typo="Typo.subtitle1">(@_movieOfTheDay.StartYear)</MudText>
                        </MudLink>
                    }
                </MudItem>
                <MudFlexBreak/>
                <MudItem>
                    <MudText Typo="Typo.h6">Genres</MudText>
                    @if (_movieGenres is null || _movieGenres.Count == 0)
                    {
                        <MudText Typo="Typo.subtitle1" Color="Color.Dark">No genres defined yet</MudText>
                    }
                    else
                    {
                        foreach (var genre in _movieGenres)
                        {
                            <MudChipSet T="Color" Class="d-inline-flex">
                                <MudChip>@genre.Name</MudChip>
                            </MudChipSet>
                        }
                    }
                </MudItem>
                <MudFlexBreak/>
                <MudItem>
                    <MudText Typo="Typo.h6">Community rating</MudText>
                    @if (_movieRating is null)
                    {
                        <MudText Typo="Typo.subtitle1" Color="Color.Dark">No community rating yet!</MudText>
                    }
                    else
                    {
                        <MovieRatingExtended MovieId="@_movieOfTheDay.Id" Size="Size.Medium" Typo="Typo.body1"/>
                    }
                </MudItem>
                <MudFlexBreak/>
                <MudItem>
                    <MudText Typo="Typo.h6">Community sentiment</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Success">Positive</MudText>
                </MudItem>
                <MudFlexBreak/>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6">Directors</MudText>
                    <MudStack Row="true" Spacing="7">
                        @if (crew is null || crew.Count == 0)
                        {
                            <MudText Typo="Typo.subtitle1" Color="Color.Dark">We have no information about the directors
                                for this movie.
                            </MudText>
                        }
                        else
                        {
                            foreach (var member in crew)
                            {
                                if (member.Job == "Writer")
                                {
                                    <MudLink
                                        Href="@($"/persona/{@member.Id}")">@member.FirstName @member.LastName</MudLink>
                                }
                            }
                        }
                    </MudStack>
                </MudItem>
                <MudFlexBreak/>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6">Writers</MudText>
                    <MudStack Row="true" Spacing="7">
                        @if (crew is null || crew.Count == 0)
                        {
                            <MudText Typo="Typo.subtitle1" Color="Color.Dark">We have no information about the writers
                                for this movie.
                            </MudText>
                        }
                        else
                        {
                            foreach (var member in crew)
                            {
                                if (member.Job == "Writer")
                                {
                                    <MudLink
                                        Href="@($"/persona/{@member.Id}")">@member.FirstName @member.LastName</MudLink>
                                }
                            }
                        }
                    </MudStack>
                </MudItem>
                <MudFlexBreak/>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6">Cast</MudText>
                    <MudStack Row="true" Spacing="7">
                        @if (crew is null || crew.Count == 0)
                        {
                            <MudText Typo="Typo.subtitle1" Color="Color.Dark">We have no information about the actors
                                for this movie.
                            </MudText>
                        }
                        else
                        {
                            foreach (var member in crew)
                            {
                                if (member.Job == "Actor")
                                {
                                    <MudPaper Elevation="0">
                                        <MudLink
                                            Href="@($"/persona/{@member.Id}")">@member.FirstName @member.LastName</MudLink>
                                        <MudText Typo="Typo.subtitle2"
                                                 Color="Color.Dark">@member.CharacterName</MudText>
                                    </MudPaper>
                                }
                            }
                        }
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudItem>
    </MudGrid>

    <MudGrid Class="mt-6">
        <MudItem xs="12">
            <MudText Typo="Typo.h4">Past picks</MudText>
            @if (pastPicks is null)
            {
                <MudText Typo="Typo.subtitle1" Color="Color.Dark">No past picks yet!
                </MudText>
            }
            else
            {
                <MudCarouselWithPagination Items=@pastPicks itemsPerCarousel="5"></MudCarouselWithPagination>
            }
        </MudItem>
    </MudGrid>

    @if (trendingMovieCollections is null)
    {
        <MudText Typo="Typo.subtitle1" Color="Color.Dark">No trending collections yet!
        </MudText>
    }
    else
    {
        if (trendingMovieCollections.Count > 0)
        {
            <MudGrid Class="mt-6">
                <MudItem xs="12">
                    <MudText Typo="Typo.h4">Trending community collections</MudText>
                    <MudCarouselWithPagination Items=@trendingMovieCollections
                                               itemsPerCarousel="5"></MudCarouselWithPagination>
                </MudItem>
            </MudGrid>
        }
    }
}



@code {
    Movie? _movieOfTheDay;
    MovieRatingSummary? _movieRating;
    List<Genre> _movieGenres = null!;
    List<GetMovieCrewMemberWithDetails> crew = null!;
    MovieRate _movieRate = null!;

    List<Movie> pastPicks = null!;
    List<MovieCollection> trendingMovieCollections = null!;

    private bool _loading;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;

        _movieOfTheDay = await MovieSvc.GetMovieOfTheDayAsync();
        if (_movieOfTheDay is not null)
        {
            var movieOfTheDayId = _movieOfTheDay.Id;

            _movieRating = await RatingSvc.GetMovieRatingSummaryByIdAsync(movieOfTheDayId);
            _movieGenres = await MovieSvc.GetMovieGenresByIdAsync(movieOfTheDayId);
            crew = await MovieSvc.GetMovieCrewByMovieIdAsync(movieOfTheDayId);
        }

        pastPicks = await MovieSvc.GetPastMoviesOfTheDay(10);

        trendingMovieCollections = await MovieSvc.GetTrendingMovieCollections(10);

        _loading = false;
    }

}