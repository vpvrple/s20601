@using Services
@using System.Security.Claims
@using s20601.Data.Models

@inject IMovieCollectionService MovieCollectionSvc

<AuthorizeView>
    <Authorized>
        <MudDialog Class="d-flex justify-start">
            <TitleContent>
                <MudText Typo="Typo.h6">Save</MudText>
            </TitleContent>
            <DialogContent>
                <MudAutocomplete T="MovieCollection"
                                 Label="Collections"
                                 @bind-Value="SelectedCollection"
                                 ToStringFunc="@(collection => collection.Name)"
                                 Variant="Variant.Outlined"
                                 ShowProgressIndicator="true"
                                 ProgressIndicatorColor="Color.Primary" SearchFunc="@SearchCollection">

                    <ItemTemplate Context="collection">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            @collection.Name
                            @if (_collectionsWithMovie.Any(c => c.MovieCollectionMovie.Movie_Id == MovieId))
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Bookmark" Color="Color.Secondary"/>
                            }

                        </MudStack>
                    </ItemTemplate>

                </MudAutocomplete>
            </DialogContent>
            <DialogActions>
                <MudButton OnClick="Cancel">Cancel</MudButton>
                <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(SelectedCollection == null)">OK
                </MudButton>
            </DialogActions>
        </MudDialog>
    </Authorized>
</AuthorizeView>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; }

    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    public MovieCollection? SelectedCollection { get; set; }

    [Parameter] public required int MovieId { get; set; }

    private string _userId = null!;
    private bool isLoading = true;
    private List<MovieCollection> _userMovieCollections;
    private List<MovieCollection> _collectionsWithMovie;

    protected override async Task OnParametersSetAsync()
    {
        isLoading = true;
        var authState = await AuthenticationStateTask;
        var user = authState.User;
        
        if (user.Identity?.IsAuthenticated == true)
        {
            _userId = user.FindFirstValue(ClaimTypes.NameIdentifier) ?? "";
            var allUserCollections = await MovieCollectionSvc.GetUserMovieCollections(_userId);
            _userMovieCollections = allUserCollections
                .Where(x => x.Type == CollectionType.Custom
                            && x.MovieCollectionUsers.Any(u => u.IdUser == _userId && u.Role != CollectionRole.Viewer))
                .ToList();
            var allUserCollectionsWithMovie = await MovieCollectionSvc.GetUserCollectionsContainingMovie(_userId, MovieId);
            _collectionsWithMovie = allUserCollectionsWithMovie.Where(x => x.Type == CollectionType.Custom
                                                                           && x.MovieCollectionUsers.Any(u => u.IdUser == _userId && u.Role != CollectionRole.Viewer))
                                                                               .ToList();
        }

        isLoading = false;
    }

    private async Task Submit()
    {
        if (SelectedCollection != null)
        {
            await MovieCollectionSvc.AddMovieToMovieCollection(SelectedCollection.Id, MovieId, _userId);
            MudDialog.Close(DialogResult.Ok(SelectedCollection.Id));
        }
    }

    private async Task<IEnumerable<MovieCollection>> SearchCollection(string collectionName, CancellationToken token)
    {
        if (string.IsNullOrEmpty(collectionName))
        {
            return _userMovieCollections.Take(10).OrderBy(x => x.CreatedAt);
        }

        return  _userMovieCollections.Where(x => x.Name.Contains(collectionName, StringComparison.InvariantCultureIgnoreCase));
    }

    private void Cancel() => MudDialog.Cancel();

}
