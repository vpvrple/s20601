@page "/movie-collections/{username}"

@using System.Security.Claims
@using s20601.Services
@using s20601.Components.Common.Components
@using s20601.Data.Models
@using System.Linq.Expressions
@using s20601.Components.Common.Components
@using s20601.Components.MovieCollections.Dialogs
@using s20601.Data.Models.DTOs

@inject IMovieCollectionService MovieCollectionSvc
@inject IUserService UserSvc
@inject IDialogService DialogService
@inject NavigationManager Navigation

<AuthorizeView>
    <Authorized>
        @if (_loading)
        {
            <MudProgressLinear Color="Color.Default" Indeterminate="true"/>
        }
        else
        {
            if (_isLoggedInUser)
            {
                <MudText Typo="Typo.h6">My collections</MudText>
                <MudStack Row="true" AlignItems="AlignItems.Baseline" Class="mt-3">
                    <MudButton Class="pa-2 align-center" @onclick="OpenCreateMovieCollectionDialog"
                               Variant="Variant.Filled"
                               StartIcon="@Icons.Material.Filled.PlaylistAdd" Color="Color.Primary">
                        Create
                        movie
                        collection
                    </MudButton>
                    <MudSpacer/>
                    <MudButton StartIcon="@Icons.Material.Filled.FilterList">Filter</MudButton>
                    <MudButton StartIcon="@Icons.Material.Filled.Sort">Sort</MudButton>
                </MudStack>
                
                <MudStack Row="true" Class="mt-6">
                            <MudStack>
                            <MudGrid Spacing="3">
                                @foreach (var collection in _movieCollections!)
                                {
                                    <MudItem>
                                        <MudCard Style="height: 100%; width: 280px">
                                            <MudCardHeader>
                                            <CardHeaderContent>
                                                <MudStack Row="true" AlignItems="AlignItems.Baseline">
                                                    @if (collection.Visibility == CollectionVisibility.Public)
                                                    {
                                                        <MudIcon Icon="@Icons.Material.Filled.Public"
                                                                 Color="Color.Success"/>
                                                    }
                                                    else
                                                    {
                                                        <MudIcon Icon="@Icons.Material.Filled.PublicOff"
                                                                 Color="Color.Error"/>
                                                    }
                                                        <MudIconButton Icon="@Icons.Material.Filled.Group" OnClick="@(() =>OpenMembersDialogAsync(collection.Id))"></MudIconButton>
                                                </MudStack>
                                            </CardHeaderContent>
                                                <CardHeaderActions>
                                                    
                                                    <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                                                             AnchorOrigin="Origin.BottomRight"
                                                             TransformOrigin="Origin.TopRight">
                                                        @{
                                                            var currentUserMemberInfo = collection.Members.FirstOrDefault(m => m.Key.Id == _processedUserId);
                                                        }

                                                        @if (currentUserMemberInfo.Key != null) // Check if user is a member
                                                        {
                                                            @if (currentUserMemberInfo.Value == CollectionRole.Owner)
                                                            {
                                                                <MudMenuItem Class="d-flex align-items-center"
                                                                             Icon="@Icons.Material.Filled.Delete"
                                                                             IconColor="Color.Error"
                                                                             OnClick="@(() => DeleteCollectionAsync(collection))"
                                                                             Disabled="@(collection.Type != CollectionType.Custom)">
                                                                    Delete
                                                                </MudMenuItem>
                                                            }
                                                            else if (collection.Type == CollectionType.Custom)
                                                            {
                                                                <MudMenuItem Class="d-flex align-items-center"
                                                                             Icon="@Icons.Material.Filled.ExitToApp"
                                                                             IconColor="Color.Warning"
                                                                             OnClick="@(() => LeaveCollectionAsync(collection))">
                                                                    Leave
                                                                </MudMenuItem>
                                                            }
                                                        }
                                                    </MudMenu>
                                                </CardHeaderActions>
                                            </MudCardHeader>
                                            <MudLink Href="@($"/movie-collection/{collection.Id}")"
                                                     Underline="Underline.None">
                                                <MudImage Src="favicon.png"
                                                          ObjectFit="ObjectFit.None"
                                                          Alt="Movie poster"
                                                          Elevation="0"
                                                          Height="300"
                                                          Width="280"/>
                                                <MudCardContent>
                                                    <MudStack>
                                                        <MudText Typo="Typo.subtitle1" Align="Align.Center">
                                                            @(_movieCollections.IndexOf(collection) + 1). @((collection.Name.Length > 10) 
                                                                                                              ? $"{collection.Name.Substring(0, 10)}..." 
                                                                                                              : collection.Name)
                                                            <MudText Typo="Typo.subtitle2">
                                                                @((collection.Description.Length > 10) 
                                                                    ? $"{collection.Description.Substring(0, 10)}..." 
                                                                    : collection.Description)
                                                            </MudText>

                                                            <MudText Typo="Typo.subtitle2">
                                                                Movies: @GetMovieCount(collection.Id)</MudText>
                                                            <MudText Typo="Typo.subtitle2">Created
                                                                at: @collection.CreatedAt.ToShortDateString()</MudText>
                                                        </MudText>
                                                    </MudStack>
                                                </MudCardContent>
                                            </MudLink>
                                        </MudCard>
                                    </MudItem>
                                }
                            </MudGrid>
                        </MudStack>
                </MudStack>
            }
            else
            {
                <MudText Typo="Typo.h6">@Username's collections</MudText>
                <MudTabs Style="align-items: center;" Rounded="true" ApplyEffectsToContainer="true"
                         PanelClass="pa-6 ma-2">
                    <MudTabPanel Icon="@Icons.Material.Filled.VideoLibrary" Text="Personal collections">
                        <MudStack Row="true">
                            @if (_movieCollections?.Count == 0)
                            {
                                <MudText Typo="Typo.body1">No collections found!</MudText>
                            }
                            else
                            {
                                <MudStack>
                                    <MudGrid Spacing="3">
                                        @foreach (var collection in _movieCollections)
                                        {
                                            <MudItem>
                                                <MudLink Href="@($"/movie-collection/{collection.Id}")"
                                                         Underline="Underline.None">
                                                    <MudCard Style="height: 100%; width: 280px">
                                                        <MudImage Src="favicon.png"
                                                                  ObjectFit="ObjectFit.None"
                                                                  Alt="Movie poster"
                                                                  Elevation="0"
                                                                  Height="300"
                                                                  Width="280"/>
                                                        <MudCardContent>
                                                            <MudStack>
                                                                <MudText Typo="Typo.subtitle1" Align="Align.Center">
                                                                    @(_movieCollections.IndexOf(collection) + 1). @collection.Name
                                                                    <MudText Typo="Typo.subtitle2">
                                                                        @((collection.Description.Length > 20) ? $"{collection.Description.Substring(0, 20)}..." : collection.Description)
                                                                    </MudText>

                                                                    <MudText Typo="Typo.subtitle2">
                                                                        Movies: @GetMovieCount(collection.Id)</MudText>
                                                                    <MudText Typo="Typo.subtitle2">Created
                                                                        at: @collection.CreatedAt.ToShortDateString()</MudText>
                                                                </MudText>
                                                            </MudStack>
                                                        </MudCardContent>
                                                    </MudCard>
                                                </MudLink>
                                            </MudItem>
                                        }
                                    </MudGrid>
                                </MudStack>
                            }
                        </MudStack>
                    </MudTabPanel>
                </MudTabs>
            }
        }

    </Authorized>

    <NotAuthorized>
        <MudText>You must be signed in to view collections.</MudText>
    </NotAuthorized>
</AuthorizeView>



@code
{
    [Parameter] public string Username { get; set; } = string.Empty;

    private List<GetMovieCollectionWithDetails>? _movieCollections;
    private bool _loading = true;
    private Dictionary<int, int> _movieCounts = new();
    private string _processedUserId = null!;
    private bool _isLoggedInUser = false;

    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        var authState = await AuthenticationStateTask;
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true && user.Identity.Name == Username)
        {
            _isLoggedInUser = true;
            _processedUserId = user.FindFirstValue(ClaimTypes.NameIdentifier) ?? "";
        }
        else
        {
            var userInfoByParameterUsername = await UserSvc.GetUserByUsername(Username);
            if (userInfoByParameterUsername == null)
            {
                Navigation.NavigateTo("notfound");
                return;
            }

            _processedUserId = userInfoByParameterUsername.Id;
        }

        await LoadMovieCollectionsAsync(_processedUserId);
        _loading = false;
    }

    private async Task LoadMovieCollectionsAsync(string userId)
    {
        _loading = true;

        StateHasChanged();
        
        Expression<Func<s20601.Data.Models.MovieCollection, bool>>? filter = null;

        if (_isLoggedInUser)
        {
            filter = mc => mc.MovieCollectionUsers.Any(mcu => mcu.IdUser == userId);
        }
        else
        {
            filter = mc => mc.MovieCollectionUsers.Any(mcu => mcu.IdUser == userId) && mc.Visibility == CollectionVisibility.Public;
        }

        _movieCollections = await MovieCollectionSvc.GetMovieCollectionsWithDetails(filter);

        _movieCounts.Clear();
        if (_movieCollections != null)
        {
            foreach (var collection in _movieCollections)
            {
                var count = await MovieCollectionSvc.GetMovieCountForCollection(collection.Id);
                _movieCounts[collection.Id] = count;
            }
        }

        _loading = false;
        StateHasChanged();
    }

    private int GetMovieCount(int collectionId) => _movieCounts.TryGetValue(collectionId, out var c) ? c : 0;

    private async Task OpenCreateMovieCollectionDialog()
    {
        var dialog = await DialogService.ShowAsync<CreateMovieCollectionDialog>("CreateMovieCollectionDialog");
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is GetMovieCollectionWithDetails newCollection)
        {
            _movieCollections.Add(newCollection);
            _movieCounts[newCollection.Id] = 0; // Initialize movie count
            StateHasChanged();
        }
    }

    private async Task OpenMembersDialogAsync(int collectionId)
    {
        var parameters = new DialogParameters()
        {
            { "CollectionId", collectionId }
        };
        var dialog = await DialogService.ShowAsync<CollectionMembersDialog>("Collection members", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is IDictionary<ApplicationUser, CollectionRole> updatedMembers)
        {
            var collectionToUpdate = _movieCollections.FirstOrDefault(c => c.Id == collectionId);
            if (collectionToUpdate != null)
            {
                collectionToUpdate.Members = updatedMembers;
                StateHasChanged();
            }
        }
    }
    
    private async Task LeaveCollectionAsync(GetMovieCollectionWithDetails collection)
    {
        var parameters = new DialogParameters<DeleteConfirmationDialog>
        {
            { x => x.ContentText, $"Do you really want to leave the collection '{collection.Name}'?" },
            { x => x.ButtonText, "Leave" }
        };

        var dialog = await DialogService.ShowAsync<DeleteConfirmationDialog>("Leave Collection", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {

                await MovieCollectionSvc.LeaveCollectionAsync(collection.Id, _processedUserId);
                await LoadMovieCollectionsAsync(_processedUserId);
            
        }
    }
    
    private async Task DeleteCollectionAsync(GetMovieCollectionWithDetails collection)
    {
        var parameters = new DialogParameters<DeleteConfirmationDialog>
        {
            { x => x.ContentText, $"Do you really want to delete the collection '{collection.Name}'?" },
            { x => x.ButtonText, "Delete" }
        };

        var dialog = await DialogService.ShowAsync<DeleteConfirmationDialog>("Delete Collection", parameters);
        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            await MovieCollectionSvc.DeleteMovieCollection(collection.Id);
            await LoadMovieCollectionsAsync(_processedUserId);
        }
    }
}