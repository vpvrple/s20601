@page "/movie-collection/{MovieCollectionId:int}"

@using Services
@using s20601.Data.Models.DTOs
@using s20601.Data.Models

@inject IMovieCollectionService MovieCollectionSvc

@if (movieCollection is null)
{
    <MudProgressCircular Color="Color.Default" Indeterminate="true" />
}
else
{
    <MudText Class="mt-6" Typo="Typo.h4">@movieCollection.Name</MudText>
}
<MudGrid>
    @if (moviesInCollection is null)
    {
        <MudProgressCircular Color="Color.Default" Indeterminate="true" />
    }
    else
    {
        @foreach (var movie in moviesInCollection)
        {
            <MudItem>
                <MudCard>
                    <MudImage Src="favicon.png"
                              ObjectFit="ObjectFit.None"
                              Alt="Movie poster"
                              Elevation="0"
                              Height="300"
                              Width="280" />
                    <MudCardContent>
                        <MudStack>
                            <MudText Typo="Typo.h6" Align="Align.Center">
                                @(moviesInCollection.IndexOf(movie) + 1). @movie.Title
                                <MudText Typo="Typo.subtitle2">(@movie.StartYear) @(movie.Runtime / 60) hours @(movie.Runtime % 60) minutes</MudText>
                            </MudText>

                            <MudDivider />
                            <MudStack Row="true" Class="justify-center">
                                @* <MovieRatingExtended RateCount="movie.MovieRatingSummary.RateCount" AvgRating="movie.MovieRatingSummary.AvgRating" Size="Size.Small" Typo="Typo.subtitle2" /> *@
                                <MovieRatingExtended MovieId="movie.Id" Size="Size.Medium" Typo="Typo.body1" />
                            </MudStack>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }
    }
</MudGrid>

@code {

    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    [Parameter]
    required public int MovieCollectionId { get; set; }
    private string userId = null!;
    private s20601.Data.Models.MovieCollection movieCollection = null!;
    private List<MovieWithRating> moviesInCollection = null!;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;

        if (authState.User.Identity.IsAuthenticated)
        {
            userId = authState.User.Claims.First().Value;
        }
        movieCollection = await MovieCollectionSvc.GetMovieCollectionById(MovieCollectionId);
        moviesInCollection = await MovieCollectionSvc.GetMoviesWithRatingOfMovieCollectionById(MovieCollectionId);

    }
}