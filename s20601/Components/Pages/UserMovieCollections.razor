@page "/movie-collections/{username}"

@using System.Security.Claims
@using s20601.Services
@using s20601.Components.Shared
@using s20601.Data.Models

@inject IMovieCollectionService MovieCollectionSvc
@inject IUserService UserSvc
@inject IDialogService DialogService

<AuthorizeView>
    <Authorized>
        @if (_loading)
        {
            <MudProgressLinear Color="Color.Default" Indeterminate="true"/>
        }
        else
        {
            if (_isLoggedInUser)
            {
                <MudTabs Style="align-items: center;" Rounded="true" ApplyEffectsToContainer="true"
                         PanelClass="pa-6 ma-2">
                    <MudTabPanel Icon="@Icons.Material.Filled.VideoLibrary" Text="My collections">

                        <MudStack Row="true">
                            @if (_movieCollections?.Count == 0)
                            {
                                <MudButton @onclick="OpenDialogAsync"
                                           Variant="Variant.Filled"
                                           StartIcon="@Icons.Material.Filled.PlaylistAdd"
                                           Color="Color.Primary">Create movie collection
                                </MudButton>
                            }
                            else
                            {
                                <MudStack>
                                    <MudButton Class="pa-2 align-center" @onclick="OpenDialogAsync"
                                               Variant="Variant.Filled"
                                               StartIcon="@Icons.Material.Filled.PlaylistAdd" Color="Color.Primary">
                                        Create
                                        movie
                                        collection
                                    </MudButton>
                                    <MudSpacer></MudSpacer>
                                    <MudGrid Spacing="3">
                                        @foreach (var collection in _movieCollections!)
                                        {
                                            <MudItem>
                                                <MudCard Style="height: 100%; width: 280px">
                                                    <MudCardHeader>
                                                        <CardHeaderContent>
                                                        </CardHeaderContent>
                                                        <CardHeaderActions>
                                                            <MudMenu Icon="@Icons.Material.Filled.MoreVert"
                                                                     AnchorOrigin="Origin.BottomRight"
                                                                     TransformOrigin="Origin.TopRight">
                                                                @if (collection.Type == CollectionType.Custom)
                                                                {
                                                                    <MudMenuItem Class="d-flex align-items-center"
                                                                                 Icon="@Icons.Material.Filled.Delete"
                                                                                 IconColor="Color.Error"
                                                                                 OnClick="@(() => DeleteCollectionAsync(collection))">
                                                                        Delete
                                                                    </MudMenuItem>
                                                                }
                                                                else
                                                                {
                                                                    <MudMenuItem Disabled="true"
                                                                                 Class="d-flex align-items-center"
                                                                                 Icon="@Icons.Material.Filled.Delete"
                                                                                 IconColor="Color.Error"
                                                                                 OnClick="@(() => DeleteCollectionAsync(collection))">
                                                                        Delete
                                                                    </MudMenuItem>
                                                                }
                                                            </MudMenu>
                                                        </CardHeaderActions>
                                                    </MudCardHeader>
                                                    <MudLink Href="@collection.GetUrl()" Underline="Underline.None">
                                                        <MudImage Src="favicon.png"
                                                                  ObjectFit="ObjectFit.None"
                                                                  Alt="Movie poster"
                                                                  Elevation="0"
                                                                  Height="300"
                                                                  Width="280"/>
                                                        <MudCardContent>
                                                            <MudStack>
                                                                <MudText Typo="Typo.subtitle1" Align="Align.Center">
                                                                    @(_movieCollections.IndexOf(collection) + 1). @((collection.Name.Length > 10) ? $"{collection.Name.Substring(0, 10)}..." : collection.Name)
                                                                    <MudText Typo="Typo.subtitle2">
                                                                        @((collection.Description.Length > 10) ? $"{collection.Description.Substring(0, 10)}..." : collection.Description)
                                                                    </MudText>

                                                                    <MudText Typo="Typo.subtitle2">
                                                                        Movies: @GetMovieCount(collection.Id)</MudText>
                                                                    <MudText Typo="Typo.subtitle2">Created
                                                                        at: @collection.CreatedAt.ToShortDateString()</MudText>
                                                                </MudText>
                                                            </MudStack>
                                                        </MudCardContent>
                                                    </MudLink>
                                                </MudCard>
                                            </MudItem>
                                        }
                                    </MudGrid>
                                </MudStack>
                            }
                        </MudStack>
                    </MudTabPanel>
                    <MudTabPanel Icon="@Icons.Material.Filled.GroupWork" Text="Shared Collections">
                        <MudText Typo="Typo.body1">No shared collections found. Share yours with others or ask someone
                            to do
                            it
                            for you!
                        </MudText>
                    </MudTabPanel>
                    <MudTabPanel Icon="@Icons.Material.Filled.Group" Text="Community Collections">
                        <MudText Typo="Typo.body1">Nothing here, someone has to be the first!</MudText>
                    </MudTabPanel>

                </MudTabs>
            }
            else
            {
                <MudText Typo="Typo.h6">@Username's collections</MudText>
                <MudTabs Style="align-items: center;" Rounded="true" ApplyEffectsToContainer="true"
                         PanelClass="pa-6 ma-2">
                    <MudTabPanel Icon="@Icons.Material.Filled.VideoLibrary" Text="Personal collections">
                        <MudStack Row="true">
                            @if (_movieCollections?.Count == 0)
                            {
                                <MudText Typo="Typo.body1">No collections found!</MudText>
                            }
                            else
                            {
                                <MudStack>
                                    <MudGrid Spacing="3">
                                        @foreach (var collection in _movieCollections)
                                        {
                                            <MudItem>
                                                <MudLink Href="@collection.GetUrl()" Underline="Underline.None">
                                                    <MudCard Style="height: 100%; width: 280px">
                                                        <MudImage Src="favicon.png"
                                                                  ObjectFit="ObjectFit.None"
                                                                  Alt="Movie poster"
                                                                  Elevation="0"
                                                                  Height="300"
                                                                  Width="280"/>
                                                        <MudCardContent>
                                                            <MudStack>
                                                                <MudText Typo="Typo.subtitle1" Align="Align.Center">
                                                                    @(_movieCollections.IndexOf(collection) + 1). @collection.Name
                                                                    <MudText Typo="Typo.subtitle2">
                                                                        @((collection.Description.Length > 20) ? $"{collection.Description.Substring(0, 20)}..." : collection.Description)
                                                                    </MudText>

                                                                    <MudText Typo="Typo.subtitle2">
                                                                        Movies: @GetMovieCount(collection.Id)</MudText>
                                                                    <MudText Typo="Typo.subtitle2">Created
                                                                        at: @collection.CreatedAt.ToShortDateString()</MudText>
                                                                </MudText>
                                                            </MudStack>
                                                        </MudCardContent>
                                                    </MudCard>
                                                </MudLink>
                                            </MudItem>
                                        }
                                    </MudGrid>
                                </MudStack>
                            }
                        </MudStack>
                    </MudTabPanel>
                    <MudTabPanel Icon="@Icons.Material.Filled.GroupWork" Text="Collaborations">
                        <MudText Typo="Typo.body1">No collaboration collections found.</MudText>
                    </MudTabPanel>
                </MudTabs>
            }
        }

    </Authorized>

    <NotAuthorized>
        <MudText>You must be signed in to view collections.</MudText>
    </NotAuthorized>
</AuthorizeView>

@code
{
    [Parameter] public string Username { get; set; } = string.Empty;

    // Change the type to match the namespace of the returned type
    private List<s20601.Data.Models.MovieCollection>? _movieCollections;
    private bool _loading = true;
    private Dictionary<int, int> _movieCounts = new();
    private string _processedUserId = null!;
    private bool _isLoggedInUser = false;

    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        var authState = await AuthenticationStateTask;
        var user = authState.User;

        if (user.Identity.Name == Username)
        {
            _isLoggedInUser = true;
            _processedUserId = user.FindFirstValue(ClaimTypes.NameIdentifier) ?? "";
        }
        else
        {
            var userInfoByParameterUsername = await UserSvc.GetUserByUsernameAsync(Username);
            _processedUserId = userInfoByParameterUsername!.Id;
        }

        await LoadMovieCollectionsAsync(_processedUserId);

        _loading = false;
    }

    private async Task LoadMovieCollectionsAsync(string userId)
    {
        _loading = true;

        var userMovieCollections = await MovieCollectionSvc.GetUserMovieCollections(userId);
        _movieCollections = new List<s20601.Data.Models.MovieCollection>();
        foreach (var collection in userMovieCollections)
        {
            var collectionData = await MovieCollectionSvc.GetMovieCollectionById(collection.Id);
            if (collectionData == null) continue;
            _movieCollections.Add(collectionData);
            var count = await MovieCollectionSvc.GetMovieCountForCollection(collectionData.Id);
            _movieCounts[collectionData.Id] = count;
        }

        _loading = false;
        StateHasChanged();
    }

    private int GetMovieCount(int collectionId) => _movieCounts.TryGetValue(collectionId, out var c) ? c : 0;

    private async Task OpenDialogAsync()
    {
        var dialog = await DialogService.ShowAsync<CreateMovieCollectionDialog>("CreateMovieCollectionDialog");

        var result = await dialog.Result;
        if (result?.Data is s20601.Data.Models.MovieCollection newCollection)
        {
            _movieCollections?.Add(newCollection);
            _movieCounts[newCollection.Id] = 0;
            StateHasChanged();
        }
    }

    private async Task DeleteCollectionAsync(s20601.Data.Models.MovieCollection collection)
    {
        var parameters = new DialogParameters<DeleteConfirmationDialog>
        {
            { x => x.ContentText, $"Do you really want to delete the collection '{collection.Name}'?" },
            { x => x.ButtonText, "Delete" }
        };

        var dialog = await DialogService.ShowAsync<DeleteConfirmationDialog>("Delete Collection", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await MovieCollectionSvc.DeleteMovieCollection(collection.Id);
            _movieCollections.Remove(collection);
            StateHasChanged();
        }
    }
}