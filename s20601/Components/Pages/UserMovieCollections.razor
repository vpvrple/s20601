@page "/movie-collections/{username}"

@using System.Security.Claims
@using s20601.Data.Models
@using s20601.Services

@inject IMovieCollectionService MovieCollectionSvc
@inject IUserService UserSvc
@inject IDialogService DialogService

<AuthorizeView>
    <Authorized>
        <MudTabs Style="align-items: center;" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6 ma-2">
            <MudTabPanel Icon="@Icons.Material.Filled.VideoLibrary" Text="My collections">
                <MudStack Row="true">
                    @if (isLoading)
                    {
                        <MudProgressLinear Color="Color.Default" Indeterminate="true" />
                        <MudProgressLinear Color="Color.Default" Indeterminate="true" />
                        <MudProgressLinear Color="Color.Default" Indeterminate="true" />
                    }
                    else if (movieCollections?.Count == 0)
                    {
                        <MudButton @onclick="OpenDialogAsync" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.PlaylistAdd" Color="Color.Primary">Create movie list</MudButton>
                    }
                    else
                    {
                        <MudStack>
                            <MudButton Class="pa-2 align-center" @onclick="OpenDialogAsync" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.PlaylistAdd" Color="Color.Primary">Create movie list</MudButton>
                            <MudSpacer></MudSpacer>
                            <MudGrid Spacing="2">
                                @foreach (var collection in movieCollections)
                                {
                                    <MudItem>
                                        <MudLink Href="@collection.GetUrl()" Underline="Underline.None">
                                            <MudCard Style="height: 100%; width: 280px">
                                                <MudImage Src="favicon.png"
                                                          ObjectFit="ObjectFit.None"
                                                          Alt="Movie poster"
                                                          Elevation="0"
                                                          Height="300"
                                                          Width="280" />
                                                <MudCardContent>
                                                    <MudStack>
                                                        <MudText Typo="Typo.subtitle1" Align="Align.Center">
                                                            @(movieCollections.IndexOf(collection) + 1). @collection.Name
                                                            <MudText Typo="Typo.subtitle2">
                                                                @((collection.Description.Length > 20) ?
                                                                                                                        $"{collection.Description.Substring(0, 20)}..." :
                                                                                                                        collection.Description)
                                                            </MudText>
                                                            <MudText Typo="Typo.subtitle2">Created at: @collection.CreatedAt.ToShortDateString()</MudText>
                                                            <MudText Typo="Typo.subtitle2">Movies: @GetMovieCount(collection.Id)</MudText>
                                                        </MudText>
                                                    </MudStack>
                                                </MudCardContent>
                                            </MudCard>
                                        </MudLink>
                                    </MudItem>
                                }
                            </MudGrid>
                        </MudStack>

                    }
                </MudStack>
            </MudTabPanel>
            <MudTabPanel Icon="@Icons.Material.Filled.GroupWork" Text="Shared Collections">
                <MudText Typo="Typo.body1">No shared collections found. Share yours with others or ask someone to do it for you!</MudText>
            </MudTabPanel>
            <MudTabPanel Icon="@Icons.Material.Filled.Group" Text="Community Collections">
                <MudText Typo="Typo.body1">Nothing here, someone has to be the first!</MudText>
            </MudTabPanel>

        </MudTabs>
    </Authorized>

    <NotAuthorized>
        <MudText>You must be signed in to view collections.</MudText>
    </NotAuthorized>
</AuthorizeView>

@code
{
    [Parameter]
    public string username { get; set; } = string.Empty;
    // Change the type to match the namespace of the returned type
    private List<s20601.Data.Models.MovieCollection>? movieCollections = null!;
    private bool isLoading = true;

    private Dictionary<int, int> movieCounts = new();

    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    protected override async Task OnInitializedAsync()
    {
        await LoadMovieCollectionsAsync();
    }

    private async Task LoadMovieCollectionsAsync()
    {
        isLoading = true;
        var authState = await AuthenticationStateTask;
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            var userId = user.FindFirstValue(ClaimTypes.NameIdentifier) ?? "";
            {
                var userMovieCollections = await MovieCollectionSvc.GetUserMovieCollections(userId);
                movieCollections = new List<s20601.Data.Models.MovieCollection>();
                foreach (var collection in userMovieCollections)
                {
                    var collectionData = await MovieCollectionSvc.GetMovieCollectionById(collection.Id);
                    if (collectionData != null)
                    {
                        movieCollections.Add(collectionData);
                        var count = await MovieCollectionSvc.GetMovieCountForCollection(collectionData.Id);
                        movieCounts[collectionData.Id] = count;
                    }

                }
            }
        }
        isLoading = false;
        StateHasChanged();
    }

    private int GetMovieCount(int collectionId) => movieCounts.TryGetValue(collectionId, out var c) ? c : 0;

    private async Task OpenDialogAsync()
    {
        var dialog = await DialogService.ShowAsync<CreateMovieCollectionDialog>("CreateMovieCollectionDialog");

        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadMovieCollectionsAsync();
        }
    }
}