@using s20601.Services
@using s20601.Data.Models.DTOs;
@using s20601.Data.Models;

@inject IReviewService ReviewSvc

    @if (!userReviewed)
    {
        <AuthorizeView Policy="CanPostReview" Context="authContext">
            <Authorized Context="innerContext">
                <ReviewInput Processing="@_processing" OnPostReview="PostReview" />
            </Authorized>
            <NotAuthorized Context="innerContext">
                
                    @if (innerContext.User.HasClaim(c => c.Type == "ReviewLimitReached"))
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-6 mb-6">You have already posted a review in the last 24 hours. Please wait before posting another one.</MudAlert>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info" Class="mt-6 mb-6">You need at least 1 reputation point to post a review. If you have between 1 and 21 points, you can only post one review every 24 hours.</MudAlert>
                    }
            </NotAuthorized>
        </AuthorizeView>
    }
    else if (_editingReviewId.HasValue)
    {
        var reviewToEdit = reviews.FirstOrDefault(r => r.Id == _editingReviewId.Value);
        if (reviewToEdit != null)
        {
             <ReviewInput Processing="@_processing" OnPostReview="@(UpdateReview)" ExistingReview="@reviewToEdit.Content" OnCancel="@CancelEdit" />
        }
    }

@if (_loading)
{
    <MudProgressLinear Color="Color.Default" Indeterminate="true" />
}
else
{
    @foreach (var review in reviews)
    {
        if (_editingReviewId != review.Id)
        {
            <Review ReviewParam="@review"
            OnRemove="RemoveFromList"
            OnVote="OnVote"
            OnEdit="OnEditReview" />
        }
    }

}

@code {

    [Parameter] public Movie Movie { get; set; }

    private bool _processing = false;
    private bool _loading;
    private bool userReviewed = false;
    private List<GetMovieReviewWithRating?> reviews = null!;
    private int? _editingReviewId;

    protected override async Task OnInitializedAsync()
    {
        _loading = true; 
        userReviewed = await ReviewSvc.AlreadyReviewed(Movie.Id);
        reviews = await ReviewSvc.GetMovieReviewsWithRating(Movie.Id);
        _loading = false;
    }

    private async Task PostReview(string review)
    {
        if (string.IsNullOrWhiteSpace(review)) return;

        _processing = true;

        await ReviewSvc.AddReview(review, Movie.Id);

        reviews = await ReviewSvc.GetMovieReviewsWithRating(Movie.Id);

        userReviewed = true;

        StateHasChanged();

        _processing = false;
    }

    private async Task UpdateReview(string content)
    {
        if (string.IsNullOrWhiteSpace(content) || !_editingReviewId.HasValue) return;

        _processing = true;
        
        await ReviewSvc.UpdateReview(_editingReviewId.Value, content);

        _editingReviewId = null;
        reviews = await ReviewSvc.GetMovieReviewsWithRating(Movie.Id);
        
        StateHasChanged();
        
        _processing = false;
    }

    private async Task OnEditReview(int reviewId)
    {
        _editingReviewId = reviewId;
        StateHasChanged();
        await Task.CompletedTask;
    }

    private void CancelEdit()
    {
        _editingReviewId = null;
        StateHasChanged();
    }

    private async Task RemoveFromList(int reviewId)
    {
        reviews.RemoveAll(x => x.Id == reviewId);
        userReviewed = false;
        await Task.CompletedTask;
    }

    private async Task OnVote(VoteReviewChange vote)
    {
        var review = reviews.FirstOrDefault(x => x?.Id == vote.ReviewId);
        if (review != null)
        {
            if (vote.PreviousVote == ReviewRateType.Like)
                review.LikeRating--;
            else if (vote.PreviousVote == ReviewRateType.Dislike)
                review.DislikeRating--;

            if (vote.CurrentVote == ReviewRateType.Like)
                review.LikeRating++;
            else if (vote.CurrentVote == ReviewRateType.Dislike)
                review.DislikeRating++;

            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    
    public class VoteReviewChange
    {
        
        public int ReviewId { get; set; }
        public ReviewRateType? PreviousVote { get; set; }
        public ReviewRateType? CurrentVote { get; set; }

        public VoteReviewChange(int reviewId, ReviewRateType? previousVote, ReviewRateType? currentVote)
        {
            ReviewId = reviewId;
            PreviousVote = previousVote;
            CurrentVote = currentVote;
        }

    }
}