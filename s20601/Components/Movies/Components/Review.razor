@using s20601.Services;
@using s20601.Data.Models;
@using System.Security.Claims
@using s20601.Data.Models.DTOs

@inject IReviewService ReviewSvc
@inject NavigationManager NavigationManager

@if (_loading)
{
    <MudProgressLinear Indeterminate="true" Color="Color.Default"></MudProgressLinear>
}
else
{
    <MudChat>
        <MudAvatar>
            @ReviewParam.Username[0]
        </MudAvatar>
        <MudChatHeader Name="@ReviewParam.Username" Time="@ReviewParam.CreatedAt.ToString()"/>
        <MudChatBubble Style="width: 100%;">
            @ReviewParam.Content
        </MudChatBubble>
        <MudChatFooter>
            <AuthorizeView>
                <Authorized>
                    @{
                        var authenticatedUserId = @context.User.FindFirstValue(ClaimTypes.NameIdentifier) ?? "";
                    }
                    <MudIconButton Color="@_colorLike" Icon="@Icons.Material.Filled.ThumbUp" OnClick="@(() => Vote(ReviewParam.Id, ReviewRateType.Like, authenticatedUserId))"/>
                    @ReviewParam.LikeRating
                    <MudIconButton Color="@_colorDislike" Icon="@Icons.Material.Filled.ThumbDown" OnClick="@(() => Vote(ReviewParam.Id, ReviewRateType.Dislike, authenticatedUserId))"/>
                    @ReviewParam.DislikeRating

                    @if (authenticatedUserId == ReviewParam.AuthorId)
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@(() => Remove(ReviewParam.Id, authenticatedUserId))"/>
                    }
                </Authorized>
                <NotAuthorized>
                    <MudIconButton Icon="@Icons.Material.Filled.ThumbUp" OnClick="@NavigateToLoginPage" />
                    @ReviewParam.LikeRating
                    <MudIconButton Icon="@Icons.Material.Filled.ThumbDown" OnClick="@NavigateToLoginPage" />
                    @ReviewParam.DislikeRating
                </NotAuthorized>
            </AuthorizeView>
        </MudChatFooter>
    </MudChat>
}

@code {
    
    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;
    [Parameter] public required GetMovieReviewWithRating ReviewParam { get; set; }
    private Color _colorLike;
    private Color _colorDislike;
    private ReviewRateType? _currentVote;
    private bool _loading;
    [Parameter] public required EventCallback<int> OnRemove { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _loading =  true;
        var authState = await AuthenticationStateTask;
        var user = authState.User;
        if (user.Identity?.IsAuthenticated == true)
        {
            var authenticatedUserId = user.FindFirstValue(ClaimTypes.NameIdentifier) ?? "";
            _currentVote = await ReviewSvc.GetUserVoteByReview(ReviewParam.Id, authenticatedUserId);
            SetVoteButtonColor(_currentVote);
        }
        _loading = false;
    }

    private async Task Remove(int reviewId, string userId)
    {
        await ReviewSvc.RemoveReviewAsync(reviewId, userId);

        await OnRemove.InvokeAsync(reviewId);
    }

    private void NavigateToLoginPage() => NavigationManager.NavigateTo("account/login", true);

    [Parameter]
    public required EventCallback<ReviewList.VoteReviewChange> OnVote { get; set; }

    private async Task Vote(int reviewId, ReviewRateType? newVote, string userId)
    {
        if (_currentVote == newVote)
        {
            newVote = null;
        }
        
        await ReviewSvc.VoteReview(reviewId, userId, newVote);
        
        await OnVote.InvokeAsync(new ReviewList.VoteReviewChange(reviewId, _currentVote, newVote));
        _currentVote = newVote;
        SetVoteButtonColor(_currentVote);
        StateHasChanged();
    
    }

    private async Task SetVoteButtonColor(ReviewRateType? vote)
    {
        if (vote == _currentVote)
        {
            _colorLike = Color.Default;
            _colorDislike = Color.Default;
        }

        if (vote == ReviewRateType.Like)
        {
            _colorLike = Color.Success;
            _colorDislike = Color.Default;
        }

        if (vote == ReviewRateType.Dislike)
        {
            _colorLike = Color.Default;
            _colorDislike = Color.Error;
        }
    }
}
