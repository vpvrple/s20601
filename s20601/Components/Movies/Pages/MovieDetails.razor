@page "/movie/{MovieId:int}"

@using Services
@using s20601.Components.Common.Components
@using s20601.Components.Movies.Components
@using s20601.Data.Models

@inject IMovieService MovieSvc

@if (_loading)
{
    <MudProgressLinear Color="Color.Default" Indeterminate="true" />
}
else
{

    <MudGrid>
        <MudItem xs="4">
            <MudPaper Elevation="0">
                <MovieCoverComponent MovieId="@_movie.Id" />
            </MudPaper>
        </MudItem>
        <MudItem xs="8">
            <MudStack>
                <MudPaper Elevation="0">
                    <MudStack Row="true" AlignItems="AlignItems.Start">
                        <MudLink Href="@($"movie/{_movie.Id}")" Typo="Typo.h5">
                            @_movie.Title
                            <MudText Typo="Typo.subtitle1">(@_movie.StartYear)</MudText>
                        </MudLink>
                        <MudSpacer />
                        <MovieEditRequestButton Movie="@_movie" ButtonText="Edit" DialogTitle="Create movie update request" />
                        <MovieShareButton Movie="@_movie" />
                    </MudStack>

                </MudPaper>


                <MudPaper Elevation="0">
                    <MudText Typo="Typo.h6">Genres</MudText>
                    @if (_movieGenres.Count == 0)
                    {
                        <MudText Typo="Typo.subtitle1" Color="Color.Dark">No genres defined yet</MudText>
                    }
                    else
                    {
                        foreach (var genre in _movieGenres)
                        {
                            <MudChipSet T="Color" Class="d-inline-flex">
                                <MudChip>@genre.Name</MudChip>
                            </MudChipSet>
                        }
                    }
                </MudPaper>

                <MudPaper Elevation="0">
                    <MudText Typo="Typo.h6">Community rating</MudText>
                    <MovieRatingExtended MovieId="@_movie.Id" Size="Size.Medium" />
                </MudPaper>


                <MudPaper Elevation="0">
                    <MudText Typo="Typo.h6">Community sentiment</MudText>
                    <CommunitySentiment MovieId="@_movie.Id" />
                </MudPaper>

                <MudPaper Elevation="0">
                    <MudText Typo="Typo.h6">Overview</MudText>
                    @if (_overview is not null)
                    {
                        <MudText Typo="Typo.body1">
                            @_overview
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body1">
                            We don't have information about movie overview for this title. Help us figure this out by editing this page!
                        </MudText>
                    }
                    
                </MudPaper>
            </MudStack>
        </MudItem>
    </MudGrid>

    <MudPaper Class="mt-6" Elevation="0">
        <MudText Typo="Typo.h4">Movie crew</MudText>
        <MovieCrewList Movie="@_movie" />
    </MudPaper>

    <MudPaper Class="mt-6" Elevation="0">
        <MudText Typo="Typo.h4">Reviews</MudText>
        <ReviewList Movie="_movie" />
    </MudPaper>

}

@code
{
    [Parameter] public required int MovieId { get; set; }
    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    private Movie _movie = null!;
    private List<Genre> _movieGenres = null!;

    private bool _loading;
    private string? _overview;

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        _movie = await MovieSvc.GetMovieByIdAsync(MovieId);
        _overview = await MovieSvc.GetMovieOverviewById(MovieId);
        _movieGenres = await MovieSvc.GetMovieGenresByIdAsync(MovieId);
        _loading = false;
    }
}