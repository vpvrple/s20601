@using System.Security.Claims
@using s20601.Services
@using s20601.Data
@using s20601.Data.Models
@using s20601.Data.Models.DTOs

@inject IUserService UserSvc
@inject IRatingService RatingSvc



@code {
    [CascadingParameter]
    public Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;

    // accept optional param; prefer claim if not provided
    [CascadingParameter]
    public string? userId { get; set; }

    private ApplicationUser? User;
    private UserRatingSummary? UserRatingSummary;

    private string[] labels = Array.Empty<string>();
    private double[] ratingData = Array.Empty<double>();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateTask;
        var user = authState?.User;

        if (string.IsNullOrEmpty(userId) && user?.Identity?.IsAuthenticated == true)
        {
            var idClaim = user.FindFirst(ClaimTypes.NameIdentifier) ?? user.FindFirst("sub");
            if (idClaim is not null)
                userId = idClaim.Value;
        }

        if (string.IsNullOrEmpty(userId))
            return;

        User = await UserSvc.GetUserByIdAsync(userId);
        UserRatingSummary = await RatingSvc.GetUserRatingSummaryAsync(userId);

        if (UserRatingSummary?.RatingDistribution is { Count: > 0 })
        {
            int ratingCount = UserRatingSummary.RatingDistribution.Count;
            labels = new string[ratingCount];
            ratingData = new double[ratingCount];

            for (int i = 0; i < ratingCount; i++)
            {
                var r = UserRatingSummary.RatingDistribution[i];
                labels[i] = $"{r.RatingValue} stars";
                ratingData[i] = r.Frequency;
            }
        }
        else
        {
            labels = Array.Empty<string>();
            ratingData = Array.Empty<double>();
        }
    }
}