@page "/friends/{Username?}"

@using System.Security.Claims
@using Microsoft.AspNetCore.SignalR
@using s20601.Data.Models
@using s20601.Services
@using Microsoft.AspNetCore.SignalR.Client
@using s20601.Components.Friends.Components
@using s20601.Components.Users.Pages
@using s20601.Data.Models.DTOs
@using s20601.Hubs

@inject NavigationManager NavigationMgr
@inject IUserService UserSvc
@inject IChatService ChatSvc
@inject IFriendService FriendSvc
@inject IHubContext<ChatHub> HubContext


@implements IAsyncDisposable

<AuthorizeView>
    <Authorized>
        @if (_loading)
        {
            <MudProgressLinear Color="Color.Default" Indeterminate="true" />
        }
        else
        {
            <MudGrid Style="height: 80vh; width: 100%;" Class="mt-6">
                <MudItem xs="4" Style="height: 100%; overflow-y: auto;" Class="border-r mud-border-lines-default">
                    <MudTabs ActivePanelIndexChanged="OnTabChanged">
                        <MudTabPanel Text="Friends" ID='"friends"'>
                            <MudStack Class="ma-2">
                                @if (_friends.Count == 0)
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Dark">Your friend list is empty.</MudText>
                                }
                                else
                                {
                                    @foreach (var friend in _friends)
                                    {
                                        <MudPaper Class="pa-2" Elevation="0" Style="cursor: pointer;" Width="100%">
                                            <MudButton OnClick="@(() => SelectedFriend(friend))" FullWidth="true" Class="justify-start">
                                                <UserAvatar UserId="@friend.Id" ></UserAvatar>
                                                <MudStack Spacing="2" Class="ml-4">
                                                        @friend.UserName
                                                </MudStack>
                                            </MudButton>
                                        </MudPaper>
                                    }
                                }

                            </MudStack>
                        </MudTabPanel>
                        <MudTabPanel Text="Friend requests" ID='"friends_requests"'>
                            <MudStack Class="ma-2">
                                @if (_friendRequests.Count == 0)
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Dark">You have no pending friend requests.</MudText>
                                }
                                else
                                {
                                    @foreach (var request in _friendRequests)
                                    {
                                        <FriendRequestComponent RequesterId="@request.Id"
                                                                RequesterUsername="@request.UserName"
                                                                RequesterAvatar="@request.Avatar"
                                                                OnRequestProcessed="HandleRequestProcessed"
                                                                OnRequestSelected="SelectRequest"></FriendRequestComponent>
                                    }
                                }
                            </MudStack>
                        </MudTabPanel>
                    </MudTabs>
                </MudItem>
                <MudItem xs="8" Class="d-flex flex-column" Style="height: 100%;">
                    @if (_activeIndex == 0)
                    {
                        @if (!string.IsNullOrEmpty(Username))
                        {
                            <MudPaper Elevation="0" Style="flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column-reverse;" Class="pa-2">
                                @foreach (var message in Enumerable.Reverse(_conversation))
                                {
                                    var position = ChatBubblePosition.Start;
                                    if (message.IdSender == _authenticatedUserId)
                                    {
                                        position = ChatBubblePosition.End;
                                    }
                                    <MudChat ChatPosition="@position">
                                        <UserAvatar UserId="@message.IdSender"></UserAvatar>
                                        <MudChatHeader Name="@message.SenderUsername" Time="@message.Created.ToString()"></MudChatHeader>
                                        <MudChatBubble>
                                            @message.Content
                                        </MudChatBubble>
                                    </MudChat>
                                }
                                <MudText Typo="Typo.caption" Align="Align.Center" Class="mb-4">Start of conversation with @Username</MudText>
                            </MudPaper>

                            <MudPaper Elevation="0" Class="pa-2">
                                <MudStack Row="true" AlignItems="AlignItems.Center">
                                    <MudTextField TextUpdateSuppression="false" @bind-Value="_inputMessage" Variant="Variant.Outlined" Placeholder="Message..." Margin="Margin.Dense" FullWidth="true" Immediate="true" OnKeyDown="@HandleEnter" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Send" Color="Color.Primary" OnClick="@SendClick" />
                                </MudStack>
                            </MudPaper>
                        }
                        else
                        {
                            if (_friends.Count == 0)
                            {
                                <MudAlert>No data to display. Chat with selected friend will appear here.</MudAlert>
                            }
                            else
                            {
                                <MudAlert>Select a friend to start chatting.</MudAlert>
                            }
                        }
                    }
                    else if (_activeIndex == 1)
                    {
                        if (_selectedRequestId is not null)
                        {
                            <MudText Typo="Typo.body1" Class="mb-4">@(_selectedRequestMessage ?? "No message content")</MudText>
                        }
                        else
                        {
                            if (_friendRequests.Count == 0)
                            {
                                <MudAlert>No data to display. Friend request message will appear here.</MudAlert>
                            }
                            else
                            {
                                <MudAlert>Select a friend request to see details.</MudAlert>
                            }
                        }
                    }
                </MudItem>
            </MudGrid>
        }
    </Authorized>
</AuthorizeView>

@code {
    [Parameter] public string? Username { get; set; }
    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;
    private bool _loading;
    private List<ApplicationUser> _friendRequests = [];
    private List<ApplicationUser> _friends = [];
    private List<ChatMessage>? _conversation = [];
    private string? _inputMessage;
    private string? _friendId;
    private string? _loadedFriendUsername;
    private string? _selectedRequestMessage;
    private string? _selectedRequestId;
    private int _activeIndex;
    private HubConnection? _hubConnection;
    private string _authenticatedUserId = string.Empty;
    private string _authenticatedUsername = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        var authState = await AuthenticationStateTask;
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _authenticatedUserId = user.FindFirstValue(ClaimTypes.NameIdentifier) ?? "";
            _authenticatedUsername = user.Identity.Name ?? "";

            await RefreshData();

            _hubConnection = new HubConnectionBuilder()
                .WithUrl(NavigationMgr.ToAbsoluteUri($"/chathub?userId={_authenticatedUserId}"))
                .WithAutomaticReconnect()
                .Build();

            _hubConnection.On<string, string>("ReceiveMessage", (senderId, messageText) =>
            {
                if (_friendId == senderId)
                {
                    _conversation.Add(new ChatMessage
                    {
                        IdSender = senderId,
                        Content = messageText,
                        Created = DateTime.UtcNow,
                        SenderUsername = _loadedFriendUsername ?? "Unknown",
                        RecipientUsername = _authenticatedUsername
                    });

                    InvokeAsync(StateHasChanged);
                }
            });

            await _hubConnection.StartAsync();
        }

        _loading = false;
    }

    private async Task RefreshData()
    {
        _friends = await FriendSvc.GetFriends();
        _friendRequests = await FriendSvc.GetFriendRequests();
        StateHasChanged();
    }

    private async Task HandleRequestProcessed()
    {
        _selectedRequestId = null;
        _selectedRequestMessage = null;
        await RefreshData();
    }

    private async Task LoadConversation()
    {
        if (!string.IsNullOrEmpty(_friendId))
        {
            var conversation = await ChatSvc.GetConversation(_friendId);
            _conversation = conversation ?? [];
        }
        else
        {
            _conversation = [];
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Username != _loadedFriendUsername)
        {
            if (!string.IsNullOrEmpty(Username))
            {
                var user = await UserSvc.GetUserByUsername(Username);
                _friendId = user?.Id;
                _loadedFriendUsername = Username;
            }
            else
            {
                _friendId = null;
                _loadedFriendUsername = null;
            }
        }

        await LoadConversation();
    }

    private void SelectedFriend(ApplicationUser friend)
    {
        _activeIndex = 0;
        Username = friend.UserName;
        _friendId = friend.Id;
        _loadedFriendUsername = friend.UserName;

        NavigationMgr.NavigateTo($"/friends/{Username}");
    }

    private async Task SendClick()
    {
        var messageToSend = _inputMessage;
        if (!string.IsNullOrWhiteSpace(messageToSend) && !string.IsNullOrWhiteSpace(_friendId))
        {
            _inputMessage = string.Empty;

            var msg = await ChatSvc.SaveMessage(_friendId, messageToSend);

            if (msg != null)
            {
                _conversation.Add(new ChatMessage
                {
                    IdSender = msg.IdSender,
                    IdRecipient = msg.IdRecipient,
                    Created = msg.Created,
                    Content = msg.Content,
                    MessageStatus = msg.MessageStatus,
                    SenderUsername = _authenticatedUsername,
                    RecipientUsername = _loadedFriendUsername ?? ""
                });
            }

            await HubContext.Clients.Group(_friendId).SendAsync("ReceiveMessage", _authenticatedUserId, messageToSend);

            StateHasChanged();
        }
    }

    private async Task HandleEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await SendClick();
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private async Task SelectRequest(string requesterId)
    {
        _activeIndex = 1;
        _selectedRequestId = requesterId;
        _selectedRequestMessage = await FriendSvc.GetFriendRequestMessage(requesterId);
        StateHasChanged();
    }

    private void OnTabChanged(int index)
    {
        _activeIndex = index;
        if (_activeIndex == 0)
        {
            _selectedRequestId = null;
            _selectedRequestMessage = null;
        }
    }
}