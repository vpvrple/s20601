@page "/friends/{Username?}"

@using System.Security.Claims
@using Microsoft.AspNetCore.SignalR
@using s20601.Data.Models
@using s20601.Services
@using Microsoft.AspNetCore.SignalR.Client
@using s20601.Components.Friends.Components
@using s20601.Hubs

@inject NavigationManager Navigation
@inject IUserService UserSvc
@inject IChatService ChatSvc
@inject IFriendService FriendSvc
@inject IHubContext<ChatHub> HubContext

@implements IAsyncDisposable

<AuthorizeView>
    <Authorized>
        @if (_loading)
        {
            <MudProgressLinear Color="Color.Default" Indeterminate="true" />
        }
        else
        {
            <MudGrid Style="overflow: scroll;" Class="mt-6">
                <MudItem xs="4" Style="height: 100%; overflow-y: scroll;" Class="border-r mud-border-lines-default">
                    <MudTabs @bind-ActivePanelIndex="@_activeIndex">
                        <MudTabPanel Text="Friends" ID='"friends"'>
                            <MudStack Class="ma-2">
                                @foreach (var friend in _friends)
                                {
                                    <MudPaper Class="pa-2" Elevation="0" Style="cursor: pointer;"
                                              @onclick="() => SelectedFriend(friend)" Width="100%">
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudAvatar Color="Color.Primary">@friend.UserName[0]</MudAvatar>
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body1">@friend.UserName</MudText>
                                            </MudStack>
                                        </MudStack>
                                    </MudPaper>
                                }
                            </MudStack>
                        </MudTabPanel>
                        <MudTabPanel Text="Friend requests" ID='"friends_requests"'>
                            <MudStack Class="ma-2">
                                @foreach (var request in _friendRequests)
                                {
                                    <FriendRequestComponent RequesterId="@request.Id"
                                                            RequesterUsername="@request.UserName"
                                                            RequesterAvatar="@request.UserName[0]"
                                                            OnRequestProcessed="RefreshData"
                                                            OnRequestSelected="() => SelectRequest(request.Id)"></FriendRequestComponent>
                                }
                            </MudStack>
                        </MudTabPanel>
                    </MudTabs>
                </MudItem>
                <MudItem xs="8" Class="d-flex flex-column" Style="height: 100%;">
                    @if (_activeIndex == 0)
                    {
                        @if (!string.IsNullOrEmpty(Username))
                        {
                            <MudPaper Class="d-flex flex-column flex-grow-1 overflow-y-auto pa-4" Elevation="0">
                                <MudText Typo="Typo.caption" Align="Align.Center" Class="mb-4">Start of conversation with @Username</MudText>
                                @foreach (var message in _conversation)
                                {

                                    <MudChat ChatPosition="@(message.IdSender == _authenticatedUserId ? ChatBubblePosition.End : ChatBubblePosition.Start)">
                                        <MudAvatar>@message.IdSender[0]</MudAvatar>
                                        <MudChatHeader Name="@message.IdSender" Time="@message.Created.ToString()"></MudChatHeader>
                                        <MudChatBubble>
                                            @message.Content
                                        </MudChatBubble>
                                    </MudChat>
                                }
                            </MudPaper>

                            <MudPaper Elevation="0" Class="pa-2 mt-auto">
                                <MudStack Row="true" AlignItems="AlignItems.Center">
                                    <MudTextField TextUpdateSuppression="false" @bind-Value="_inputMessage" Variant="Variant.Outlined" Placeholder="Message..." Margin="Margin.Dense" FullWidth="true" Immediate="true" OnKeyDown="@HandleEnter" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Send" Color="Color.Primary" OnClick="@SendClick" />
                                </MudStack>
                            </MudPaper>
                        }
                    }
                    else if (_activeIndex == 1)
                    {
                        <MudText Typo="Typo.body1" Class="mb-4">@_selectedRequestMessage</MudText>
                    }

                    else
                    {
                        <MudPaper Class="d-flex flex-column flex-grow-1 justify-center align-center" Elevation="0">
                            <MudText Typo="Typo.body1" Color="Color.Dark">Select a friend to start chatting</MudText>
                        </MudPaper>
                    }
                </MudItem>
            </MudGrid>
        }
    </Authorized>
</AuthorizeView>

@code {
    [Parameter] public string? Username { get; set; }
    [CascadingParameter] public Task<AuthenticationState> AuthenticationStateTask { get; set; } = null!;
    private bool _loading;
    private List<ApplicationUser> _friendRequests = [];
    private List<ApplicationUser> _friends = [];
    private List<Message>? _conversation = [];
    private string? _inputMessage;
    private string? _friendId;
    private string? _loadedFriendUsername;
    private string? _selectedRequestMessage;
    private int _activeIndex;
    private HubConnection? _hubConnection;
    private string _authenticatedUserId;

    protected override async Task OnInitializedAsync()
    {
        _loading = true;
        var authState = await AuthenticationStateTask;
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            _authenticatedUserId = user.FindFirstValue(ClaimTypes.NameIdentifier) ?? "";

            await RefreshData();

            _hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri($"/chathub?userId={_authenticatedUserId}"))
                .WithAutomaticReconnect()
                .Build();

            _hubConnection.On<string, string>("ReceiveMessage", (senderId, messageText) =>
            {
                if (_friendId == senderId)
                {
                    _conversation.Add(new Message
                    {
                        IdSender = senderId,
                        Content = messageText,
                        Created = DateTime.UtcNow
                    });

                    InvokeAsync(StateHasChanged);
                }
            });

            await _hubConnection.StartAsync();
        }

        _loading = false;
    }

    private async Task RefreshData()
    {
        _friends = await FriendSvc.GetFriends();
        _friendRequests = await FriendSvc.GetFriendRequests();
        StateHasChanged();
    }

    private async Task LoadConversation()
    {
        if (!string.IsNullOrEmpty(_friendId))
        {
            _conversation = await ChatSvc.GetConversation(_friendId);
        }
        else
        {
            _conversation = [];
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Username != _loadedFriendUsername)
        {
            if (!string.IsNullOrEmpty(Username))
            {
                var user = await UserSvc.GetUserByUsername(Username);
                _friendId = user?.Id;
                _loadedFriendUsername = Username;
            }
            else
            {
                _friendId = null;
                _loadedFriendUsername = null;
            }
        }

        await LoadConversation();
    }

    private void SelectedFriend(ApplicationUser friend)
    {
        Username = friend.UserName;
        _friendId = friend.Id;
        _loadedFriendUsername = friend.UserName;

        Navigation.NavigateTo($"/friends/{Username}");
    }

    private async Task SendClick()
    {
        var messageToSend = _inputMessage;
        if (!string.IsNullOrWhiteSpace(messageToSend) && !string.IsNullOrWhiteSpace(_friendId))
        {
            _inputMessage = string.Empty;

            var msg = await ChatSvc.SaveMessage(_friendId, messageToSend);

            _conversation.Add(msg);

            await HubContext.Clients.Group(_friendId).SendAsync("ReceiveMessage", _authenticatedUserId, messageToSend);

            StateHasChanged();
        }
    }

    private async Task HandleEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await SendClick();
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private async Task SelectRequest(string requesterId)
    {
        _selectedRequestMessage = await FriendSvc.GetFriendRequestMessage(requesterId);
    }
}
