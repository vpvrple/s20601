@using System.ComponentModel.DataAnnotations
@using s20601.Services
@inject IFriendService FriendSvc

<AuthorizeView>
    <Authorized>
        <MudDialog Class="d-flex justify-start">
            <TitleContent>
                <MudText Typo="Typo.h6">Send Friend Request</MudText>
                <MudText Typo="Typo.body1">Add optional message to introduce yourself.</MudText>
            </TitleContent>
            <DialogContent>
                <EditForm Model="@_model" @ref="_form" Context="editFormContext">
                <DataAnnotationsValidator />
                <MudTextField AutoGrow 
                              T="string" 
                              Label="Request message" 
                              Variant="Variant.Outlined" 
                              @bind-Value="@_model.Message" 
                              For="@(() => _model.Message)" 
                              Lines="3"
                              Counter="@AddFriendForm.MaxMessageLength"
                              Immediate="true"/>
                </EditForm>
            </DialogContent>
            <DialogActions>
                <MudButton OnClick="@Cancel">Cancel</MudButton>
                <MudButton Color="Color.Primary" OnClick="@Submit">Send</MudButton>
            </DialogActions>
        </MudDialog>
    </Authorized>
</AuthorizeView>


@code {
    
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; }
    
    [Parameter]
    public required string RequesterId { get; init; }
    
    [Parameter]
    public required string FriendId { get; init; }

    private readonly string _defaultRequestMessage = "Hi! I would like to add you to my friend list!";
    
    private async Task Submit()
    {
        if (string.IsNullOrEmpty(_model.Message))
        {
            _model.Message = _defaultRequestMessage;
        }
        await FriendSvc.SendFriendRequest(FriendId, _model.Message);
        MudDialog.Close(DialogResult.Ok(true));
    }
    
    private void Cancel() =>  MudDialog.Cancel();
    
    private AddFriendForm _model = new();
    private EditForm _form = null!;
    
    public class AddFriendForm
    {
        public const int MaxMessageLength = 300;
        
        [StringLength(MaxMessageLength, ErrorMessage = "Message cannot exceed {1} characters.")]
        public string Message { get; set; } = "";
    }
}