@using s20601.Data.Models
@using s20601.Services

@inject ISnackbar Snackbar
@inject IUserService UserSvc

<MudDialog>
    <DialogContent>
        <MudForm>
            <MudCard Elevation="0">
                <MudCardContent>
                    <MudStack>
                        <MudStack Row="true">
                            <MudFileUpload T="IBrowserFile" FilesChanged="@(UploadAvatar)">
                                        <ActivatorContent>
                                            <MudButton Variant="Variant.Filled"
                                                       Color="Color.Primary">
                                                Upload your avatar
                                            </MudButton>
                                        </ActivatorContent>
                                    </MudFileUpload>
                            @if (_avatar is not null)
                            {
                                <MudChip T="string" Color="Color.Info" OnClose="@ClearAvatar">
                                    @(_avatar?.Name)
                                </MudChip>
                            }
                            else
                            {
                                <MudChip T="string">No File</MudChip>
                            }
                        </MudStack>

                        <MudTextField @bind-Value="@_profileDescription" Label="Profile description"
                                      HelperText="Tell something about yourself!" Variant="Variant.Outlined"/>
                    </MudStack>
                </MudCardContent>
                <MudCardActions>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick="@(Submit)">Update
                    </MudButton>
                </MudCardActions>
            </MudCard>

        </MudForm>
    </DialogContent>
</MudDialog>


@code {

    [Parameter] public ApplicationUser User { get; set; }
    [Parameter] public EventCallback OnProfileUpdated { get; set; }
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; }

    private string? _profileDescription;
    private IBrowserFile? _avatar;

    private MudFileUpload<IBrowserFile>? _fileUpload;
    private MemoryStream? _uploadedFileStream;
    
    protected override void OnInitialized()
    {
        if (User is not null)
        {
            _profileDescription = User.ProfileDescription;
        }
    }

    private void ClearAvatar()
    {
        _avatar = null;
        _uploadedFileStream?.Dispose();
        _uploadedFileStream = null;
        StateHasChanged();
    }

    private async Task UploadAvatar(IBrowserFile avatar)
    {
        long maxFileSize = 5 * 1024 * 1024;
        if (avatar.Size > maxFileSize)
        {
            Snackbar.Add("File is too large. Max size is 5MB.", Severity.Error);
            return;
        }

        try
        {
            _uploadedFileStream?.DisposeAsync();
            _uploadedFileStream = new MemoryStream();
            await avatar.OpenReadStream(maxFileSize).CopyToAsync(_uploadedFileStream);
            _uploadedFileStream.Position = 0;
            _avatar = avatar;
            Snackbar.Add("Your avatar was uploaded successfully!", Severity.Info);

        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
            Snackbar.Add("Failed to read uploaded file.", Severity.Error);
            _avatar = null;
            _uploadedFileStream?.DisposeAsync();
            _uploadedFileStream = null;
        }
    }

    private async Task Submit()
    {
        bool changesMade = false;

        if (_avatar is not null)
        {
            var newAvatar = await UserSvc.UpdateUserAvatar(_uploadedFileStream, _avatar.Name);
            User.Avatar = newAvatar;
            changesMade = true;
        }
        else if (_avatar is null && User.Avatar is not null)
        {
            await UserSvc.UpdateUserAvatar(_uploadedFileStream, null);
            User.Avatar = null;
            changesMade = true;
        }

        if (_profileDescription != User.ProfileDescription)
        {
            var newDescription = await UserSvc.UpdateUserProfileDescription(_profileDescription);
            User.ProfileDescription = newDescription;
            changesMade = true;
        }

        if (!changesMade)
        {
            Snackbar.Add("No changes made", Severity.Info);
        }
        else
        {
            Snackbar.Add("Your profile was updated.", Severity.Info);
            await OnProfileUpdated.InvokeAsync();
        }

        MudDialog.Close(DialogResult.Ok(true));
    }

}